{% load static %} 
{% load my_filters %} 

<div x-data="{ 
        open: false, 
        images: [], 
        currentIndex: 0,
        touchStartX: 0,
        touchEndX: 0,
        get currentSrc() { return this.images[this.currentIndex] || '' },
        next() {
            this.currentIndex = (this.currentIndex < this.images.length - 1) ? this.currentIndex + 1 : 0;
        },
        prev() {
            this.currentIndex = (this.currentIndex > 0) ? this.currentIndex - 1 : this.images.length - 1;
        },
        handleSwipe() {
            if (this.touchStartX - this.touchEndX > 50) this.next(); // Swipe Gauche -> Suivant
            if (this.touchEndX - this.touchStartX > 50) this.prev(); // Swipe Droite -> Précédent
        }
     }"
     @open-lightbox.window="images = $event.detail.images; currentIndex = $event.detail.index; open = true"
     @keydown.escape.window="open = false"
     @keydown.arrow-left.window="if(open) prev()"
     @keydown.arrow-right.window="if(open) next()"
     
     /* --- GESTION DU SWIPE MOBILE --- */
     @touchstart="touchStartX = $event.changedTouches[0].screenX"
     @touchend="touchEndX = $event.changedTouches[0].screenX; handleSwipe()"
     
     x-show="open"
     style="display: none;"
     class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 group/lightbox touch-none"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak>
    
    <button @click="open = false" class="absolute top-4 right-4 text-white/50 hover:text-white transition-colors z-50 p-2">
        <i class="fa-solid fa-xmark text-4xl"></i>
    </button>

    <button @click.stop="prev()" 
            class="absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white hover:scale-110 transition-all z-50 p-2 sm:p-4 bg-black/20 hover:bg-black/50 rounded-full backdrop-blur-sm">
        <i class="fa-solid fa-chevron-left text-2xl sm:text-3xl"></i>
    </button>

    <img :src="currentSrc" 
         class="max-w-full max-h-full rounded shadow-2xl object-contain select-none cursor-grab active:cursor-grabbing"
         alt="Aperçu grand format"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-50 scale-95"
         x-transition:enter-end="opacity-100 scale-100">

    <button @click.stop="next()" 
            class="absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white hover:scale-110 transition-all z-50 p-2 sm:p-4 bg-black/20 hover:bg-black/50 rounded-full backdrop-blur-sm">
        <i class="fa-solid fa-chevron-right text-2xl sm:text-3xl"></i>
    </button>

    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/50 px-3 py-1 rounded-full text-white text-sm backdrop-blur-sm border border-white/10">
        <span x-text="currentIndex + 1"></span> / <span x-text="images.length"></span>
    </div>

</div>